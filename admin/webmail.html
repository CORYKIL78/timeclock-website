<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cirkle Webmail - Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        .login-box {
            background: white;
            border-radius: 20px;
            padding: 50px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 450px;
            width: 100%;
        }
        .login-box h1 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2em;
        }
        .login-box p {
            color: #666;
            margin-bottom: 30px;
        }
        .input-field {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        .input-field:focus {
            outline: none;
            border-color: #667eea;
        }
        .login-btn {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .login-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }
        .error {
            color: #f44336;
            margin-top: 10px;
            display: none;
        }
        .webmail-panel {
            display: none;
            min-height: 100vh;
            background: #f5f5f5;
        }
        .header {
            background: white;
            padding: 20px 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            color: #667eea;
            font-size: 1.8em;
        }
        .logout-btn {
            padding: 10px 20px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        .container {
            display: flex;
            height: calc(100vh - 80px);
        }
        .sidebar {
            width: 250px;
            background: white;
            padding: 20px;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
        }
        .compose-btn {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 20px;
        }
        .compose-btn:hover {
            background: #5568d3;
        }
        .nav-item {
            padding: 12px 15px;
            margin-bottom: 5px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #666;
            font-weight: 500;
        }
        .nav-item:hover {
            background: #f5f5f5;
        }
        .nav-item.active {
            background: #667eea;
            color: white;
        }
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        .view {
            display: none;
            background: white;
            border-radius: 15px;
            padding: 30px;
            min-height: 100%;
        }
        .view.active {
            display: block;
        }
        .email-list {
            margin-top: 20px;
        }
        .email-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .email-item:hover {
            background: #f9f9f9;
        }
        .email-checkbox {
            width: 20px;
            height: 20px;
        }
        .email-info {
            flex: 1;
        }
        .email-subject {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        .email-preview {
            color: #666;
            font-size: 0.9em;
        }
        .email-date {
            color: #999;
            font-size: 0.85em;
        }
        .compose-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .form-group label {
            font-weight: 600;
            color: #333;
        }
        .form-group input, .form-group textarea {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        .editor-toolbar {
            display: flex;
            gap: 5px;
            padding: 10px;
            background: #f5f5f5;
            border: 2px solid #ddd;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            flex-wrap: wrap;
        }
        .editor-btn {
            padding: 8px 12px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
        }
        .editor-btn:hover {
            background: #e0e0e0;
        }
        .editor-content {
            min-height: 300px;
            padding: 15px;
            border: 2px solid #ddd;
            border-top: none;
            border-radius: 0 0 8px 8px;
            background: white;
            outline: none;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover {
            background: #5568d3;
        }
        .btn-secondary {
            background: #f5f5f5;
            color: #666;
        }
        .btn-secondary:hover {
            background: #e0e0e0;
        }
        .btn-danger {
            background: #f44336;
            color: white;
        }
        .btn-danger:hover {
            background: #d32f2f;
        }
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <h1>üìß Cirkle Webmail</h1>
            <p>Admin Email Portal</p>
            <input type="text" class="input-field" id="username" placeholder="Username">
            <input type="password" class="input-field" id="pin" placeholder="PIN" maxlength="6">
            <button class="login-btn" onclick="login()">Access Webmail</button>
            <p class="error" id="loginError">Invalid credentials. Please try again.</p>
        </div>
    </div>

    <!-- Webmail Panel -->
    <div class="webmail-panel" id="webmailPanel">
        <div class="header">
            <h1>üìß Cirkle Webmail</h1>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>

        <div class="container">
            <div class="sidebar">
                <button class="compose-btn" onclick="showCompose()">‚úçÔ∏è Compose</button>
                <div class="nav-item active" onclick="switchView('inbox')">üì• Inbox</div>
                <div class="nav-item" onclick="switchView('sent')">üì§ Sent</div>
                <div class="nav-item" onclick="switchView('drafts')">üìù Drafts</div>
                <div class="nav-item" onclick="switchView('deleted')">üóëÔ∏è Deleted</div>
            </div>

            <div class="main-content">
                <!-- Compose View -->
                <div class="view active" id="composeView">
                    <h2>‚úçÔ∏è Compose Email</h2>
                    <form class="compose-form" onsubmit="sendEmail(event)">
                        <div class="form-group">
                            <label>To (separate multiple emails with commas):</label>
                            <input type="text" id="emailTo" required placeholder="recipient@example.com, another@example.com">
                        </div>
                        <div class="form-group">
                            <label>Subject:</label>
                            <input type="text" id="emailSubject" required placeholder="Email subject">
                        </div>
                        <div class="form-group">
                            <label>Message:</label>
                            <div class="editor-toolbar">
                                <button type="button" class="editor-btn" onclick="formatText('bold')" title="Bold"><b>B</b></button>
                                <button type="button" class="editor-btn" onclick="formatText('italic')" title="Italic"><i>I</i></button>
                                <button type="button" class="editor-btn" onclick="formatText('underline')" title="Underline"><u>U</u></button>
                                <button type="button" class="editor-btn" onclick="formatText('strikeThrough')" title="Strikethrough"><s>S</s></button>
                                <button type="button" class="editor-btn" onclick="formatText('justifyLeft')" title="Align Left">‚¨ÖÔ∏è</button>
                                <button type="button" class="editor-btn" onclick="formatText('justifyCenter')" title="Align Center">‚ÜîÔ∏è</button>
                                <button type="button" class="editor-btn" onclick="formatText('justifyRight')" title="Align Right">‚û°Ô∏è</button>
                                <button type="button" class="editor-btn" onclick="formatText('insertUnorderedList')" title="Bullet List">‚Ä¢ List</button>
                                <button type="button" class="editor-btn" onclick="formatText('insertOrderedList')" title="Numbered List">1. List</button>
                                <button type="button" class="editor-btn" onclick="changeFontSize('larger')" title="Larger">A+</button>
                                <button type="button" class="editor-btn" onclick="changeFontSize('smaller')" title="Smaller">A-</button>
                            </div>
                            <div class="editor-content" id="emailBody" contenteditable="true"></div>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button type="submit" class="btn btn-primary">üì§ Send Email</button>
                            <button type="button" class="btn btn-secondary" onclick="saveDraft()">üíæ Save Draft</button>
                            <button type="button" class="btn btn-secondary" onclick="clearCompose()">üóëÔ∏è Clear</button>
                        </div>
                    </form>
                </div>

                <!-- Inbox View -->
                <div class="view" id="inboxView">
                    <h2>üì• Inbox</h2>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="selectAll('inbox')">Select All</button>
                        <button class="btn btn-danger" onclick="deleteSelected('inbox')">Delete Selected</button>
                    </div>
                    <div class="email-list" id="inboxList"></div>
                </div>

                <!-- Sent View -->
                <div class="view" id="sentView">
                    <h2>üì§ Sent Mail</h2>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="selectAll('sent')">Select All</button>
                        <button class="btn btn-danger" onclick="deleteSelected('sent')">Delete Selected</button>
                    </div>
                    <div class="email-list" id="sentList"></div>
                </div>

                <!-- Drafts View -->
                <div class="view" id="draftsView">
                    <h2>üìù Drafts</h2>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="selectAll('drafts')">Select All</button>
                        <button class="btn btn-danger" onclick="deleteSelected('drafts')">Delete Selected</button>
                    </div>
                    <div class="email-list" id="draftsList"></div>
                </div>

                <!-- Deleted View -->
                <div class="view" id="deletedView">
                    <h2>üóëÔ∏è Deleted</h2>
                    <div class="action-buttons">
                        <button class="btn btn-danger" onclick="permanentlyDelete()">Permanently Delete Selected</button>
                    </div>
                    <div class="email-list" id="deletedList"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const USERNAME = 'cirkledevelopment.co.uk';
        const PIN = '061025';
        const MAILERSEND_TOKEN = 'mlsn.fe7903a1eb16b303bcd64d8192c666f32ab8214a481e6f220c689b4332b7aed1';
        const BACKEND_URL = 'https://timeclock-backend.marcusray.workers.dev';

        let emailData = {
            inbox: [],
            sent: [],
            drafts: [],
            deleted: []
        };

        // Check if already logged in
        if (sessionStorage.getItem('webmail_logged_in') === 'true') {
            showWebmail();
        }

        function login() {
            const username = document.getElementById('username').value;
            const pin = document.getElementById('pin').value;
            const error = document.getElementById('loginError');
            
            if (username === USERNAME && pin === PIN) {
                sessionStorage.setItem('webmail_logged_in', 'true');
                showWebmail();
            } else {
                error.style.display = 'block';
                setTimeout(() => error.style.display = 'none', 3000);
            }
        }

        function logout() {
            sessionStorage.removeItem('webmail_logged_in');
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('webmailPanel').style.display = 'none';
        }

        function showWebmail() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('webmailPanel').style.display = 'block';
            loadEmails();
        }

        function switchView(view) {
            // Update nav
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update views
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(view + 'View').classList.add('active');
            
            renderEmails(view);
        }

        function showCompose() {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('composeView').classList.add('active');
        }

        function formatText(command) {
            document.execCommand(command, false, null);
            document.getElementById('emailBody').focus();
        }

        function changeFontSize(size) {
            if (size === 'larger') {
                document.execCommand('fontSize', false, '5');
            } else {
                document.execCommand('fontSize', false, '2');
            }
            document.getElementById('emailBody').focus();
        }

        function getEmailTemplate(content) {
            return `
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        .container { max-width: 600px; margin: 0 auto; }
        .header { text-align: center; padding: 20px; background: #667eea; }
        .header img { max-width: 200px; }
        .content { padding: 30px; background: white; }
        .footer { background: #f5f5f5; padding: 20px; text-align: center; color: #666; font-size: 12px; }
        .footer a { color: #667eea; text-decoration: none; margin: 0 5px; }
        .shop-link { display: block; margin: 15px 0; color: #667eea; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="https://cirkledevelopment.co.uk/logo.png" alt="Cirkle Development" onerror="this.style.display='none'">
        </div>
        <div class="content">
            ${content}
        </div>
        <div class="footer">
            <p>¬© Cirkle Development 2024 || Building Connections, Creating Solutions</p>
            <a href="https://shop.cirkledevelopment.co.uk" class="shop-link">https://shop.cirkledevelopment.co.uk</a>
            <p>
                <a href="https://twitter.com/cirkledev">Twitter</a> ||
                <a href="https://tiktok.com/@cirkledev">TikTok</a> ||
                <a href="https://discord.gg/cirkle">Discord</a> ||
                <a href="https://www.roblox.com/groups/cirkle">Roblox</a> ||
                <a href="https://youtube.com/@cirkledev">YouTube</a>
            </p>
        </div>
    </div>
</body>
</html>
            `;
        }

        async function sendEmail(event) {
            event.preventDefault();
            
            const to = document.getElementById('emailTo').value;
            const subject = document.getElementById('emailSubject').value;
            const body = document.getElementById('emailBody').innerHTML;
            
            if (!to || !subject || !body) {
                alert('Please fill in all fields');
                return;
            }

            // Parse recipients
            const recipients = to.split(',').map(email => ({
                email: email.trim(),
                name: email.trim().split('@')[0]
            }));

            const emailHTML = getEmailTemplate(body);
            
            try {
                const response = await fetch('https://api.mailersend.com/v1/email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${MAILERSEND_TOKEN}`
                    },
                    body: JSON.stringify({
                        from: {
                            email: 'noreply@cirkledevelopment.co.uk',
                            name: 'Cirkle Development'
                        },
                        to: recipients,
                        subject: subject,
                        html: emailHTML
                    })
                });

                if (response.ok) {
                    // Save to sent
                    const sentEmail = {
                        id: Date.now(),
                        to: to,
                        subject: subject,
                        body: body,
                        date: new Date().toISOString(),
                        selected: false
                    };
                    emailData.sent.unshift(sentEmail);
                    saveEmails();
                    
                    alert('‚úÖ Email sent successfully!');
                    clearCompose();
                    switchView('sent');
                } else {
                    const error = await response.json();
                    alert('Failed to send email: ' + (error.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Send error:', error);
                alert('Failed to send email. Check console for details.');
            }
        }

        function saveDraft() {
            const to = document.getElementById('emailTo').value;
            const subject = document.getElementById('emailSubject').value;
            const body = document.getElementById('emailBody').innerHTML;
            
            const draft = {
                id: Date.now(),
                to: to,
                subject: subject || '(No Subject)',
                body: body,
                date: new Date().toISOString(),
                selected: false
            };
            
            emailData.drafts.unshift(draft);
            saveEmails();
            alert('üíæ Draft saved!');
            clearCompose();
        }

        function clearCompose() {
            document.getElementById('emailTo').value = '';
            document.getElementById('emailSubject').value = '';
            document.getElementById('emailBody').innerHTML = '';
        }

        function loadEmails() {
            const stored = localStorage.getItem('webmail_data');
            if (stored) {
                emailData = JSON.parse(stored);
            }
            renderEmails('inbox');
        }

        function saveEmails() {
            localStorage.setItem('webmail_data', JSON.stringify(emailData));
        }

        function renderEmails(folder) {
            const container = document.getElementById(folder + 'List');
            const emails = emailData[folder];
            
            if (emails.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <p>No emails in ${folder}</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = emails.map(email => `
                <div class="email-item">
                    <input type="checkbox" class="email-checkbox" ${email.selected ? 'checked' : ''} 
                           onchange="toggleSelect('${folder}', ${email.id})">
                    <div class="email-info" onclick="viewEmail('${folder}', ${email.id})">
                        <div class="email-subject">${email.subject}</div>
                        <div class="email-preview">${folder === 'sent' ? 'To: ' + email.to : email.body.replace(/<[^>]*>/g, '').substring(0, 100)}...</div>
                    </div>
                    <div class="email-date">${new Date(email.date).toLocaleDateString()}</div>
                </div>
            `).join('');
        }

        function toggleSelect(folder, id) {
            const email = emailData[folder].find(e => e.id === id);
            if (email) {
                email.selected = !email.selected;
                saveEmails();
            }
        }

        function selectAll(folder) {
            const allSelected = emailData[folder].every(e => e.selected);
            emailData[folder].forEach(e => e.selected = !allSelected);
            saveEmails();
            renderEmails(folder);
        }

        function deleteSelected(folder) {
            const selected = emailData[folder].filter(e => e.selected);
            if (selected.length === 0) {
                alert('No emails selected');
                return;
            }
            
            if (!confirm(`Delete ${selected.length} email(s)?`)) return;
            
            // Move to deleted
            emailData.deleted.unshift(...selected);
            emailData[folder] = emailData[folder].filter(e => !e.selected);
            saveEmails();
            renderEmails(folder);
        }

        function permanentlyDelete() {
            const selected = emailData.deleted.filter(e => e.selected);
            if (selected.length === 0) {
                alert('No emails selected');
                return;
            }
            
            if (!confirm(`Permanently delete ${selected.length} email(s)? This cannot be undone!`)) return;
            
            emailData.deleted = emailData.deleted.filter(e => !e.selected);
            saveEmails();
            renderEmails('deleted');
        }

        function viewEmail(folder, id) {
            const email = emailData[folder].find(e => e.id === id);
            if (!email) return;
            
            const html = `
                <div style="padding: 20px;">
                    <h3>${email.subject}</h3>
                    <p><strong>${folder === 'sent' ? 'To:' : 'From:'}</strong> ${email.to || 'Unknown'}</p>
                    <p><strong>Date:</strong> ${new Date(email.date).toLocaleString()}</p>
                    <hr style="margin: 20px 0;">
                    <div>${email.body}</div>
                    <hr style="margin: 20px 0;">
                    <button class="btn btn-secondary" onclick="renderEmails('${folder}')">Back to ${folder}</button>
                    ${folder === 'drafts' ? `<button class="btn btn-primary" onclick="editDraft(${id})">Edit Draft</button>` : ''}
                </div>
            `;
            
            document.getElementById(folder + 'List').innerHTML = html;
        }

        function editDraft(id) {
            const draft = emailData.drafts.find(d => d.id === id);
            if (!draft) return;
            
            document.getElementById('emailTo').value = draft.to;
            document.getElementById('emailSubject').value = draft.subject;
            document.getElementById('emailBody').innerHTML = draft.body;
            
            // Remove from drafts
            emailData.drafts = emailData.drafts.filter(d => d.id !== id);
            saveEmails();
            
            showCompose();
        }

        // Allow Enter key to login
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('pin')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') login();
            });
        });
    </script>
</body>
</html>
