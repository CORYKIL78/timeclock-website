<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OC Portal - Oversight & Corporate</title>
<style>
:root {
  --bg: #0b0d17;
  --bg2: #111427;
  --bg3: #171a2e;
  --bg4: #1e2140;
  --border: #252845;
  --text: #e2e5f0;
  --text2: #8890a8;
  --accent: #6366f1;
  --accent2: #818cf8;
  --green: #22c55e;
  --red: #ef4444;
  --orange: #f59e0b;
  --blue: #3b82f6;
  --radius: 10px;
  --shadow: 0 4px 24px rgba(0,0,0,.3);
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);overflow-x:hidden;min-height:100vh}
.screen{display:none;width:100%;min-height:100vh}
.screen.active{display:flex}
button{cursor:pointer;font-family:inherit}
input,select,textarea{font-family:inherit;outline:none}
::-webkit-scrollbar{width:6px}
::-webkit-scrollbar-track{background:var(--bg2)}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--accent)}

/* ====== LOGIN SCREEN ====== */
#loginScreen{align-items:center;justify-content:center;position:relative;background:radial-gradient(ellipse at center,#0f1129 0%,#060714 100%);overflow:hidden}
.stars,.stars2,.stars3{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none}
.stars{background:transparent;animation:animStars 80s linear infinite}
.stars2{background:transparent;animation:animStars 100s linear infinite}
.stars3{background:transparent;animation:animStars 120s linear infinite}

.star-dot{position:absolute;width:2px;height:2px;background:#fff;border-radius:50%;animation:twinkle 3s ease-in-out infinite alternate}
.star-dot.s2{width:1px;height:1px;opacity:.6}
.star-dot.s3{width:3px;height:3px;opacity:.4}

@keyframes twinkle{0%{opacity:.3}100%{opacity:1}}
@keyframes animStars{0%{transform:translateY(0)}100%{transform:translateY(-2000px)}}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
@keyframes pulse-ring{0%{transform:scale(.9);opacity:1}100%{transform:scale(1.4);opacity:0}}

.login-card{
  position:relative;z-index:10;background:rgba(17,20,39,.85);
  backdrop-filter:blur(20px);border:1px solid rgba(99,102,241,.2);
  border-radius:20px;padding:48px 40px;width:380px;max-width:90vw;
  text-align:center;animation:float 6s ease-in-out infinite;
  box-shadow:0 0 60px rgba(99,102,241,.08)
}
.login-card h1{font-size:28px;font-weight:700;margin-bottom:4px;background:linear-gradient(135deg,#818cf8,#6366f1);background-clip:text;-webkit-background-clip:text;-webkit-text-fill-color:transparent;color:transparent}
.login-card .subtitle{color:var(--text2);font-size:13px;margin-bottom:32px}
.login-card input{
  width:100%;padding:14px 16px;background:rgba(255,255,255,.04);
  border:1px solid var(--border);border-radius:var(--radius);
  color:var(--text);font-size:14px;margin-bottom:14px;transition:.2s
}
.login-card input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(99,102,241,.15)}
.login-card input::placeholder{color:var(--text2)}
.login-btn{
  width:100%;padding:14px;background:var(--accent);color:#fff;
  border:none;border-radius:var(--radius);font-size:15px;font-weight:600;
  transition:.2s;margin-top:8px
}
.login-btn:hover{background:var(--accent2);transform:translateY(-1px)}
.login-btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
.login-error{color:var(--red);font-size:13px;margin-top:12px;min-height:20px}

/* ====== LOADING SCREEN ====== */
#loadingScreen{align-items:center;justify-content:center;flex-direction:column;background:var(--bg)}
.loader-wrap{text-align:center}
.orbit-loader{width:80px;height:80px;position:relative;margin:0 auto 24px}
.orbit-loader .ring{position:absolute;inset:0;border-radius:50%;border:3px solid transparent}
.orbit-loader .ring:nth-child(1){border-top-color:var(--accent);animation:spin 1s linear infinite}
.orbit-loader .ring:nth-child(2){border-right-color:var(--accent2);animation:spin 1.5s linear infinite reverse;inset:8px}
.orbit-loader .ring:nth-child(3){border-bottom-color:#818cf8;animation:spin 2s linear infinite;inset:16px}
.orbit-loader .core{position:absolute;inset:22px;background:var(--accent);border-radius:50%;animation:pulse .8s ease-in-out infinite alternate;opacity:.6}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulse{0%{transform:scale(.8);opacity:.4}100%{transform:scale(1);opacity:.8}}
.loader-text{color:var(--text2);font-size:15px}

/* ====== FOUND SCREEN ====== */
#foundScreen{align-items:center;justify-content:center;flex-direction:column;gap:20px;background:var(--bg)}
.found-avatar{width:96px;height:96px;border-radius:50%;border:3px solid var(--accent);box-shadow:0 0 30px rgba(99,102,241,.3);animation:scaleIn .4s ease}
.found-text{font-size:22px;font-weight:600}
.found-text span{color:var(--accent2)}
.dashboard-btn{
  padding:14px 40px;background:var(--accent);color:#fff;border:none;
  border-radius:var(--radius);font-size:15px;font-weight:600;transition:.2s;margin-top:8px
}
.dashboard-btn:hover{background:var(--accent2);transform:translateY(-1px)}
@keyframes scaleIn{0%{transform:scale(0);opacity:0}100%{transform:scale(1);opacity:1}}

/* ====== DASHBOARD ====== */
#dashboard{display:none;flex-direction:row;min-height:100vh}
.sidebar{
  width:240px;min-width:240px;background:var(--bg2);border-right:1px solid var(--border);
  display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:50
}
.sidebar-logo{padding:24px 20px;display:flex;align-items:center;gap:8px}
.sidebar-logo span:first-child{font-size:20px;font-weight:700;color:var(--text)}
.sidebar-logo .tag{font-size:10px;background:var(--accent);color:#fff;padding:2px 8px;border-radius:20px;font-weight:600}
.sidebar nav{flex:1;padding:8px 12px;display:flex;flex-direction:column;gap:2px}
.nav-btn{
  display:flex;align-items:center;gap:10px;padding:10px 14px;
  background:transparent;border:none;color:var(--text2);
  font-size:13.5px;font-weight:500;border-radius:8px;transition:.15s;width:100%;text-align:left
}
.nav-btn:hover{background:var(--bg4);color:var(--text)}
.nav-btn.active{background:rgba(99,102,241,.12);color:var(--accent2)}
.nav-btn svg{width:18px;height:18px;flex-shrink:0}
.sidebar-user{padding:16px 20px;border-top:1px solid var(--border);display:flex;align-items:center;gap:10px}
.sidebar-user img{width:32px;height:32px;border-radius:50%}
.sidebar-user .name{font-size:13px;font-weight:500}
.sidebar-user .role{font-size:11px;color:var(--text2)}
.logout-btn{
  margin:8px 12px 12px;padding:8px;background:transparent;border:1px solid var(--border);
  color:var(--text2);border-radius:8px;font-size:12px;transition:.15s
}
.logout-btn:hover{border-color:var(--red);color:var(--red)}

.main-area{margin-left:240px;flex:1;display:flex;flex-direction:column;min-height:100vh}
.topbar{
  padding:16px 28px;display:flex;align-items:center;justify-content:space-between;
  border-bottom:1px solid var(--border);background:var(--bg);position:sticky;top:0;z-index:40
}
.topbar h2{font-size:18px;font-weight:600}
.topbar-actions{display:flex;gap:8px;align-items:center}
.btn{
  padding:8px 16px;border-radius:8px;font-size:13px;font-weight:500;
  border:none;transition:.15s;display:inline-flex;align-items:center;gap:6px
}
.btn-primary{background:var(--accent);color:#fff}
.btn-primary:hover{background:var(--accent2)}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--text2)}
.btn-outline:hover{border-color:var(--accent);color:var(--accent)}
.btn-green{background:var(--green);color:#fff}
.btn-green:hover{background:#16a34a}
.btn-red{background:var(--red);color:#fff}
.btn-red:hover{background:#dc2626}
.btn-small{padding:5px 10px;font-size:12px}

.content{padding:24px 28px;flex:1}
.tab-content{display:none}
.tab-content.active{display:block}

/* Stats row */
.stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:24px}
.stat-card{background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);padding:18px 20px}
.stat-card .label{font-size:12px;color:var(--text2);margin-bottom:6px;text-transform:uppercase;letter-spacing:.5px}
.stat-card .value{font-size:26px;font-weight:700}
.stat-card .value.green{color:var(--green)}
.stat-card .value.orange{color:var(--orange)}
.stat-card .value.red{color:var(--red)}
.stat-card .value.blue{color:var(--blue)}

/* Tables */
.table-wrap{background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.table-header{padding:14px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)}
.table-header h3{font-size:14px;font-weight:600}
table{width:100%;border-collapse:collapse}
thead th{
  padding:10px 16px;text-align:left;font-size:11px;font-weight:600;
  color:var(--text2);text-transform:uppercase;letter-spacing:.5px;
  background:rgba(255,255,255,.02);border-bottom:1px solid var(--border)
}
tbody tr{border-bottom:1px solid var(--border);transition:.1s}
tbody tr:hover{background:rgba(99,102,241,.04)}
tbody tr:last-child{border-bottom:none}
tbody td{padding:12px 16px;font-size:13px;color:var(--text)}
.user-cell{display:flex;align-items:center;gap:10px;cursor:pointer}
.user-cell img{width:32px;height:32px;border-radius:50%;flex-shrink:0}
.user-cell .name{font-weight:500}
.user-cell .id{font-size:11px;color:var(--text2)}

.badge{
  display:inline-block;padding:3px 10px;border-radius:20px;
  font-size:11px;font-weight:600;text-transform:capitalize
}
.badge-pending{background:rgba(245,158,11,.12);color:var(--orange)}
.badge-approved{background:rgba(34,197,94,.12);color:var(--green)}
.badge-rejected,.badge-denied{background:rgba(239,68,68,.12);color:var(--red)}
.badge-suspended{background:rgba(239,68,68,.12);color:var(--red)}
.badge-active{background:rgba(34,197,94,.12);color:var(--green)}
.badge-issued{background:rgba(59,130,246,.12);color:var(--blue)}

.clickable-row{cursor:pointer}
.clickable-row:hover{background:rgba(99,102,241,.06)!important}

.empty-state{text-align:center;padding:60px 20px;color:var(--text2)}
.empty-state svg{margin-bottom:12px;opacity:.4}
.empty-state p{font-size:14px}

/* ====== USER PANEL ====== */
.user-panel{
  position:fixed;top:0;right:-520px;width:520px;height:100vh;
  background:var(--bg2);border-left:1px solid var(--border);
  z-index:100;transition:right .3s ease;overflow-y:auto;
  box-shadow:-10px 0 40px rgba(0,0,0,.4)
}
.user-panel.open{right:0}
.panel-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:99;
  display:none;opacity:0;transition:opacity .2s
}
.panel-overlay.active{display:block;opacity:1}
.panel-head{padding:20px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border)}
.panel-close{background:transparent;border:none;color:var(--text2);font-size:20px;padding:4px 8px;border-radius:6px}
.panel-close:hover{background:var(--bg4);color:var(--text)}
.panel-profile{padding:24px 20px;text-align:center;border-bottom:1px solid var(--border)}
.panel-profile img{width:80px;height:80px;border-radius:50%;border:3px solid var(--accent);margin-bottom:12px}
.panel-profile h3{font-size:18px;margin-bottom:4px}
.panel-profile .dept{color:var(--text2);font-size:13px;margin-bottom:10px}
.points-display{display:inline-flex;align-items:center;gap:6px;background:var(--bg4);padding:6px 16px;border-radius:20px;font-size:14px;font-weight:600}
.points-display.positive{color:var(--green)}
.points-display.negative{color:var(--red)}

.panel-section{padding:16px 20px;border-bottom:1px solid var(--border)}
.panel-section h4{font-size:13px;color:var(--text2);margin-bottom:12px;text-transform:uppercase;letter-spacing:.5px}
.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.info-item{background:var(--bg3);padding:10px 12px;border-radius:8px}
.info-item .label{font-size:11px;color:var(--text2);margin-bottom:2px}
.info-item .value{font-size:13px;font-weight:500}
.info-item.editable{cursor:pointer;border:1px solid transparent;transition:.15s}
.info-item.editable:hover{border-color:var(--accent)}
.info-item input{background:transparent;border:none;color:var(--text);font-size:13px;font-weight:500;width:100%}
.info-item select{background:var(--bg);border:1px solid var(--border);color:var(--text);font-size:13px;padding:4px;border-radius:4px;width:100%}

.panel-tabs{display:flex;gap:0;border-bottom:1px solid var(--border)}
.panel-tab{
  flex:1;padding:10px;text-align:center;font-size:12px;font-weight:500;
  color:var(--text2);background:transparent;border:none;border-bottom:2px solid transparent;transition:.15s
}
.panel-tab:hover{color:var(--text)}
.panel-tab.active{color:var(--accent2);border-bottom-color:var(--accent)}
.panel-tab-content{display:none;padding:16px 20px}
.panel-tab-content.active{display:block}
.panel-list-item{padding:10px 12px;background:var(--bg3);border-radius:8px;margin-bottom:8px;font-size:13px}
.panel-list-item .row{display:flex;justify-content:space-between;margin-bottom:4px}
.panel-list-item .row:last-child{margin-bottom:0}

.panel-actions{padding:16px 20px;display:flex;flex-direction:column;gap:8px}
.panel-actions button{width:100%;padding:10px;border-radius:8px;font-size:13px;font-weight:500;border:none}

/* ====== MODALS ====== */
.modal-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;
  display:none;align-items:center;justify-content:center;backdrop-filter:blur(2px)
}
.modal-overlay.active{display:flex}
.modal{
  background:var(--bg2);border:1px solid var(--border);border-radius:16px;
  width:480px;max-width:90vw;max-height:85vh;overflow-y:auto;box-shadow:var(--shadow)
}
.modal-head{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.modal-head h3{font-size:16px;font-weight:600}
.modal-close{background:transparent;border:none;color:var(--text2);font-size:22px}
.modal-close:hover{color:var(--text)}
.modal-body{padding:20px 24px}
.modal-body .field{margin-bottom:16px}
.modal-body label{display:block;font-size:12px;color:var(--text2);margin-bottom:6px;font-weight:500}
.modal-body input,.modal-body select,.modal-body textarea{
  width:100%;padding:10px 12px;background:var(--bg3);border:1px solid var(--border);
  border-radius:8px;color:var(--text);font-size:13px;transition:.15s
}
.modal-body input:focus,.modal-body select:focus,.modal-body textarea:focus{border-color:var(--accent)}
.modal-body textarea{resize:vertical;min-height:80px}
.modal-body select option{background:var(--bg2)}
.modal-foot{padding:16px 24px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px}
.modal-foot button{padding:10px 24px}

/* Reason modal */
.reason-field{margin-top:12px}
.reason-field textarea{width:100%;padding:10px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:13px;min-height:60px;resize:vertical}

/* Notification toast */
.toast{
  position:fixed;bottom:24px;right:24px;z-index:300;
  padding:14px 20px;border-radius:var(--radius);font-size:13px;font-weight:500;
  transform:translateY(100px);opacity:0;transition:.3s;max-width:360px
}
.toast.show{transform:translateY(0);opacity:1}
.toast.success{background:var(--green);color:#fff}
.toast.error{background:var(--red);color:#fff}
.toast.info{background:var(--blue);color:#fff}

.loading-inline{text-align:center;padding:40px;color:var(--text2);font-size:13px}

/* Points input field for "Other" strike */
.points-field{display:none;margin-top:8px}

/* Responsive */
@media(max-width:768px){
  .sidebar{width:60px;min-width:60px}
  .sidebar-logo span:first-child,.sidebar-logo .tag,.nav-btn span,.sidebar-user .info{display:none}
  .nav-btn{justify-content:center;padding:12px}
  .main-area{margin-left:60px}
  .user-panel{width:100%;right:-100%}
  .content{padding:16px}
  .stats-row{grid-template-columns:1fr 1fr}
  .info-grid{grid-template-columns:1fr}
}
</style>
<!-- ====== Load Configuration from environment ====== -->
<script src="../config-loader.js"></script>
<script src="../.env-config.js"></script>
</head>
<body>

<!-- ====== LOGIN SCREEN ====== -->
<div id="loginScreen" class="screen active">
  <div class="stars" id="starsContainer"></div>
  <div class="login-card">
    <h1>OC Portal</h1>
    <p class="subtitle">Oversight & Corporate Administration</p>
    <input type="text" id="discordIdInput" placeholder="Discord ID" autocomplete="off" />
    <input type="password" id="pinInput" placeholder="PIN" maxlength="6" autocomplete="off" />
    <button class="login-btn" id="loginBtn">Sign In</button>
    <div class="login-error" id="loginError"></div>
  </div>
</div>

<!-- ====== LOADING SCREEN ====== -->
<div id="loadingScreen" class="screen">
  <div class="loader-wrap">
    <div class="orbit-loader">
      <div class="ring"></div>
      <div class="ring"></div>
      <div class="ring"></div>
      <div class="core"></div>
    </div>
    <p class="loader-text">Looking for your profile...</p>
  </div>
</div>

<!-- ====== FOUND SCREEN ====== -->
<div id="foundScreen" class="screen">
  <img id="foundAvatar" class="found-avatar" src="" alt="Avatar" />
  <p class="found-text">Found your profile, <span id="foundName"></span></p>
  <button class="dashboard-btn" id="goToDashboard">Take me to dashboard</button>
</div>

<!-- ====== DASHBOARD ====== -->
<div id="dashboard" class="screen">
  <aside class="sidebar">
    <div class="sidebar-logo"><span>OC</span><span class="tag">PORTAL</span></div>
    <nav>
      <button class="nav-btn active" data-tab="users"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg><span>Users</span></button>
      <button class="nav-btn" data-tab="absences"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg><span>Absences</span></button>
      <button class="nav-btn" data-tab="requests"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg><span>Requests</span></button>
      <button class="nav-btn" data-tab="payslips"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg><span>Payslips</span></button>
      <button class="nav-btn" data-tab="reports"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg><span>Reports</span></button>
      <button class="nav-btn" data-tab="strikes"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg><span>Strikes</span></button>
      <button class="nav-btn" data-tab="calendar"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><circle cx="8" cy="14" r="1"/><circle cx="12" cy="14" r="1"/><circle cx="16" cy="14" r="1"/></svg><span>Calendar</span></button>
      <button class="nav-btn" data-tab="logs"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg><span>Logs</span></button>
    </nav>
    <div class="sidebar-user">
      <img id="sidebarAvatar" src="" alt="" />
      <div class="info"><div class="name" id="sidebarName"></div><div class="role">Administrator</div></div>
    </div>
    <button class="logout-btn" id="logoutBtn">Log Out</button>
  </aside>

  <div class="main-area">
    <div class="topbar">
      <h2 id="tabTitle">Users</h2>
      <div class="topbar-actions">
        <button class="btn btn-outline" id="refreshBtn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg> Refresh</button>
      </div>
    </div>
    <div class="content">
      <!-- USERS TAB -->
      <div class="tab-content active" id="tab-users">
        <div class="stats-row" id="usersStats"></div>
        <div class="table-wrap">
          <div class="table-header"><h3>All Users</h3></div>
          <div id="usersTable"><div class="loading-inline">Loading users...</div></div>
        </div>
      </div>

      <!-- ABSENCES TAB -->
      <div class="tab-content" id="tab-absences">
        <div class="stats-row" id="absencesStats"></div>
        <div class="table-wrap">
          <div class="table-header"><h3>All Absence Requests</h3></div>
          <div id="absencesTable"><div class="loading-inline">Loading absences...</div></div>
        </div>
      </div>

      <!-- REQUESTS TAB -->
      <div class="tab-content" id="tab-requests">
        <div class="stats-row" id="requestsStats"></div>
        <div class="table-wrap">
          <div class="table-header"><h3>All Requests</h3></div>
          <div id="requestsTable"><div class="loading-inline">Loading requests...</div></div>
        </div>
      </div>

      <!-- PAYSLIPS TAB -->
      <div class="tab-content" id="tab-payslips">
        <div class="stats-row" id="payslipsStats"></div>
        <div style="margin-bottom:16px"><button class="btn btn-primary" onclick="openModal('payslipModal')">+ Send Payslip</button></div>
        <div class="table-wrap">
          <div class="table-header"><h3>All Payslips</h3></div>
          <div id="payslipsTable"><div class="loading-inline">Loading payslips...</div></div>
        </div>
      </div>

      <!-- REPORTS TAB -->
      <div class="tab-content" id="tab-reports">
        <div class="stats-row" id="reportsStats"></div>
        <div style="margin-bottom:16px"><button class="btn btn-primary" onclick="openModal('reportModal')">+ Issue Report</button></div>
        <div class="table-wrap">
          <div class="table-header"><h3>All Reports</h3></div>
          <div id="reportsTable"><div class="loading-inline">Loading reports...</div></div>
        </div>
      </div>

      <!-- STRIKES TAB -->
      <div class="tab-content" id="tab-strikes">
        <div class="stats-row" id="strikesStats"></div>
        <div style="margin-bottom:16px"><button class="btn btn-primary" onclick="openModal('strikeModal')">+ Issue Disciplinary</button></div>
        <div class="table-wrap">
          <div class="table-header"><h3>All Disciplinaries</h3></div>
          <div id="strikesTable"><div class="loading-inline">Loading disciplinaries...</div></div>

      <!-- CALENDAR TAB -->
      <div class="tab-content" id="tab-calendar">
        <div class="stats-row">
          <div class="stat-card"><div class="label">Total Events</div><div class="value" id="calendarEventsCount">-</div></div>
          <div class="stat-card"><div class="label">This Month</div><div class="value" id="calendarThisMonth">-</div></div>
          <div class="stat-card"><div class="label">Upcoming</div><div class="value" id="calendarUpcoming">-</div></div>
        </div>
        <div style="margin-bottom:16px"><button class="btn btn-primary" onclick="openModal('calendarEventModal')">+ Add Event</button></div>
        <div class="table-wrap">
          <div class="table-header"><h3>Calendar Events</h3></div>
          <div id="calendarTable"><div class="loading-inline">Loading events...</div></div>
        </div>
      </div>

      <!-- LOGS TAB -->
      <div class="tab-content" id="tab-logs">
        <div class="stats-row">
          <div class="stat-card"><div class="label">Total Logs</div><div class="value" id="logsCount">-</div></div>
          <div class="stat-card"><div class="label">Today</div><div class="value" id="logsToday">-</div></div>
          <div class="stat-card"><div class="label">This Week</div><div class="value" id="logsThisWeek">-</div></div>
        </div>
        <div class="table-wrap">
          <div class="table-header"><h3>Admin Activity Logs</h3></div>
          <div id="logsTable"><div class="loading-inline">Loading logs...</div></div>
        </div>
      </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ====== USER PANEL ====== -->
<div class="panel-overlay" id="panelOverlay"></div>
<div class="user-panel" id="userPanel">
  <div class="panel-head"><button class="panel-close" id="closePanelBtn">&larr;</button><h3>User Profile</h3></div>
  <div id="panelContent"></div>
</div>

<!-- ====== PAYSLIP MODAL ====== -->
<div class="modal-overlay" id="payslipModal">
  <div class="modal">
    <div class="modal-head"><h3>Send Payslip</h3><button class="modal-close" onclick="closeModal('payslipModal')">&times;</button></div>
    <div class="modal-body">
      <div class="field"><label>Select User</label><select id="payslipUser"></select></div>
      <div class="field"><label>Pay Period</label><input type="text" id="payslipPeriod" placeholder="e.g. January 2026" /></div>
      <div class="field"><label>Payslip Link or Attachment URL</label><input type="text" id="payslipLink" placeholder="https://..." /></div>
      <div class="field"><label>Comment</label><textarea id="payslipComment" placeholder="Optional comment..."></textarea></div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-outline" onclick="closeModal('payslipModal')">Cancel</button>
      <button class="btn btn-primary" id="sendPayslipBtn">Send Payslip</button>
    </div>
  </div>
</div>

<!-- ====== REPORT MODAL ====== -->
<div class="modal-overlay" id="reportModal">
  <div class="modal">
    <div class="modal-head"><h3>Issue Report</h3><button class="modal-close" onclick="closeModal('reportModal')">&times;</button></div>
    <div class="modal-body">
      <div class="field"><label>Select User</label><select id="reportUser"></select></div>
      <div class="field"><label>Report Type</label>
        <select id="reportType">
          <option value="">Select type...</option>
          <option value="Commendation">Commendation (+1 point)</option>
          <option value="Negative Behaviour">Negative Behaviour (-1 point)</option>
          <option value="Disruptive">Disruptive (-1 point)</option>
          <option value="Monthly Report">Monthly Report (0 points)</option>
        </select>
      </div>
      <div class="field"><label>Description</label><textarea id="reportDesc" placeholder="Describe the report..."></textarea></div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-outline" onclick="closeModal('reportModal')">Cancel</button>
      <button class="btn btn-primary" id="sendReportBtn">Send Report</button>
    </div>
  </div>
</div>

<!-- ====== STRIKE MODAL ====== -->
<div class="modal-overlay" id="strikeModal">
  <div class="modal">
    <div class="modal-head"><h3>Issue Disciplinary</h3><button class="modal-close" onclick="closeModal('strikeModal')">&times;</button></div>
    <div class="modal-body">
      <div class="field"><label>Select User</label><select id="strikeUser"></select></div>
      <div class="field"><label>Strike Type</label>
        <select id="strikeType" onchange="toggleStrikePoints()">
          <option value="">Select type...</option>
          <option value="Verbal Warning">Verbal Warning (-1 point)</option>
          <option value="Formal Warning">Formal Warning (-2 points)</option>
          <oCALENDAR EVENT MODAL ====== -->
<div class="modal-overlay" id="calendarEventModal">
  <div class="modal">
    <div class="modal-head"><h3>Add Calendar Event</h3><button class="modal-close" onclick="closeModal('calendarEventModal')">&times;</button></div>
    <div class="modal-body">
      <div class="field"><label>Event Date</label><input type="date" id="eventDate" /></div>
      <div class="field"><label>Event Title</label><input type="text" id="eventTitle" placeholder="Event title..." /></div>
      <div class="field"><label>Event Type</label>
        <select id="eventType">
          <option value="event">General Event</option>
          <option value="meeting">Meeting</option>
          <option value="deadline">Deadline</option>
          <option value="holiday">Holiday</option>
          <option value="announcement">Announcement</option>
        </select>
      </div>
      <div class="field"><label>Description</label><textarea id="eventDescription" placeholder="Event description..."></textarea></div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-outline" onclick="closeModal('calendarEventModal')">Cancel</button>
      <button class="btn btn-primary" id="addCalendarEventBtn">Add Event</button>
    </div>
  </div>
</div>

<!-- ====== ption value="Suspension">Suspension (-4 points)</option>
          <option value="Other">Other (custom points)</option>
        </sele
  calendarEvents: [],
  logs: [],ct>
      </div>
      <div class="field points-field" id="customPointsField"><label>Points to Remove</label><input type="number" id="strikeCustomPoints" placeholder="e.g. 3" min="0"/></div>
      <div class="field"><label>Description</label><textarea id="strikeDesc" placeholder="Describe the reason..."></textarea></div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-outline" onclick="closeModal('strikeModal')">Cancel</button>
      <button class="btn btn-red" id="sendStrikeBtn">Issue Disciplinary</button>
    </div>
  </div>
</div>

<!-- ====== ACTION MODAL (APPROVE/DENY) ====== -->
<div class="modal-overlay" id="actionModal">
  <div class="modal">
    <div class="modal-head"><h3 id="actionModalTitle">Confirm Action</h3><button class="modal-close" onclick="closeModal('actionModal')">&times;</button></div>
    <div class="modal-body">
      <p id="actionModalText" style="margin-bottom:14px;font-size:14px"></p>
      <div class="field"><label>Reason (optional)</label><textarea id="actionReason" placeholder="Enter reason..."></textarea></div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-outline" onclick="closeModal('actionModal')">Cancel</button>
      <button class="btn btn-primary" id="actionConfirmBtn">Confirm</button>
    </div>
  </div>
</div>

<!-- ====== TOAST ====== -->
<div class="toast" id="toast"></div>

<script>
/* ================================================================
   CONFIG & STATE
   ================================================================ */
// Load API config from environment or use defaults
const API = window.CONFIG?.WORKER_URL || 'https://timeclock-backend.marcusray.workers.dev';
const GUILD_ID = window.CONFIG?.GUILD_ID || '1310656642672627752';

// Load admin credentials from environment config
// Format: ADMIN_{DISCORD_ID}_PIN and ADMIN_{DISCORD_ID}_NAME
const ADMINS = window.CONFIG?.ADMINS || {
  '1088907566844739624': { pin: '', name: 'Marcus Ray' },
  '1002932344799371354': { pin: '', name: 'Appler Smith' },
  '1187751127039615086': { pin: '', name: 'Sam Caster' },
  '926568979747713095':  { pin: '', name: 'Teejay Everil' }
};

console.warn('[ADMIN PORTAL] Loaded credentials from:', window.CONFIG ? 'environment config' : 'defaults');
console.log('[ADMIN PORTAL] Admin users:', Object.keys(ADMINS));

const REPORT_POINTS = { 'Commendation': 1, 'Negative Behaviour': -1, 'Disruptive': -1, 'Monthly Report': 0 };
const STRIKE_POINTS = { 'Verbal Warning': -1, 'Formal Warning': -2, 'Suspension': -4 };

let state = {
  admin: null,
  users: [],
  discordMembers: [],
  absences: [],
  requests: [],
  payslips: [],
  reports: [],
  strikes: [],
  activeTab: 'users',
  selectedUser: null,
  pendingAction: null
};

/* ================================================================
   STARS GENERATION
   ================================================================ */
function generateStars() {
  const c = document.getElementById('starsContainer');
  if (!c) return;
  for (let i = 0; i < 200; i++) {
    const s = document.createElement('div');
    const size = Math.random() < 0.6 ? '' : (Math.random() < 0.5 ? 's2' : 's3');
    s.className = 'star-dot ' + size;
    s.style.left = Math.random() * 100 + '%';
    s.style.top = Math.random() * 100 + '%';
    s.style.animationDelay = (Math.random() * 5) + 's';
    s.style.animationDuration = (2 + Math.random() * 4) + 's';
    c.appendChild(s);
  }
}

/* ================================================================
   SCREEN MANAGEMENT
   ================================================================ */
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const el = document.getElementById(id);
  if (el) { el.classList.add('active'); if (id === 'dashboard') el.style.display = 'flex'; }
}

/* ================================================================
   API HELPERS
   ================================================================ */
async function apiGet(path) {
  const r = await fetch(API + path);
  return r.json();
}
async function apiPost(path, body) {
  const r = await fetch(API + path, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
  return r.json();
}

function avatarUrl(userId, hash) {
  if (hash) return `https://cdn.discordapp.com/avatars/${userId}/${hash}.png?size=128`;
  const idx = Number((BigInt(userId) >> 22n) % 6n);
  return `https://cdn.discordapp.com/embed/avatars/${idx}.png`;
}

function defaultAvatar(userId) {
  const idx = Number((BigInt(userId) >> 22n) % 6n);
  return `https://cdn.discordapp.com/embed/avatars/${idx}.png`;
}

/* ================================================================
   LOGIN FLOW
   ================================================================ */
document.getElementById('loginBtn').addEventListener('click', doLogin);
document.getElementById('pinInput').addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });

async function doLogin() {
  const id = document.getElementById('discordIdInput').value.trim();
  const pin = document.getElementById('pinInput').value.trim();
  const err = document.getElementById('loginError');
  err.textContent = '';

  if (!id || !pin) { err.textContent = 'Please enter both Discord ID and PIN.'; return; }
  if (!ADMINS[id]) { err.textContent = 'Access denied. Unknown Discord ID.'; return; }
  if (ADMINS[id].pin !== pin) { err.textContent = 'Incorrect PIN.'; return; }

  document.getElementById('loginBtn').disabled = true;
  showScreen('loadingScreen');

  try {
    // Fetch Discord profile from backend
    let avatarSrc = defaultAvatar(id);
    let displayName = ADMINS[id].name;
    
    try {
      const discordUser = await apiGet(`/api/discord/user/${id}`);
      if (discordUser?.avatar_url) avatarSrc = discordUser.avatar_url;
      if (discordUser?.global_name) displayName = discordUser.global_name;
      else if (discordUser?.username) displayName = discordUser.username;
    } catch (e) {
      console.log('Could not fetch Discord profile, using defaults:', e);
    }

    state.admin = { id, name: displayName, avatar: avatarSrc };

    await new Promise(r => setTimeout(r, 1200));
    showScreen('foundScreen');
    document.getElementById('foundAvatar').src = avatarSrc;
    document.getElementById('foundName').textContent = displayName;

  } catch (e) {
    err.textContent = 'Failed to load profile. Check connection.';
    showScreen('loginScreen');
    document.getElementById('loginBtn').disabled = false;
  }
}

/* ================================================================
   GO TO DASHBOARD
   ================================================================ */
document.getElementById('goToDashboard').addEventListener('click', async () => {
  showScreen('dashboard');
  document.getElementById('sidebarAvatar').src = state.admin.avatar;
  document.getElementById('sidebarName').textContent = state.admin.name;
  loadTab('users');
});

/* ================================================================
   TABS
   ================================================================ */
document.querySelectorAll('.nav-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const tab = btn.dataset.tab;
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    const tabEl = document.getElementById('tab-' + tab);
    if (tabEl) tabEl.classList.add('active');
    document.getElementById('tabTitle').textContent = btn.querySelector('span')?.textContent || tab;
    state.activeTab = tab;
    loadTab(tab);
  });
});

async function loadTab(tab) {
  switch(tab) {
    case 'users': await loadUsers(); break;
    case 'absences': await loadAbsences(); break;
    case 'requests': await loadRequests(); break;
    case 'payslips': await loadPayslips(); break;
    case 'reports': await loadReports(); break;
    case 'strikes': await loadStrikes(); break;
    case 'calendar': await loadCalendar(); break;
    case 'logs': await loadLogs(); break;
  }
}

document.getElementById('refreshBtn').addEventListener('click', () => loadTab(state.activeTab));

/* ================================================================
   LOAD USERS
   ================================================================ */
async function loadUsers() {
  const container = document.getElementById('usersTable');
  container.innerHTML = '<div class="loading-inline">Loading users from backend...</div>';
  try {
    // Fetch users from Google Sheets via backend API
    const data = await apiGet('/api/admin/users');
    if (!data.success || !data.users) {
      throw new Error(data.error || 'Failed to fetch users from backend');
    }
    
    const users = data.users;

    // Ensure all users have avatars
    users.forEach(u => {
      if (!u.avatar && u.discordId) u.avatar = defaultAvatar(u.discordId);
    });

    state.users = users;

    // Stats
    const total = users.length;
    const suspended = users.filter(u => u.suspended).length;
    const active = total - suspended;
    document.getElementById('usersStats').innerHTML = `
      <div class="stat-card"><div class="label">Total Users</div><div class="value blue">${total}</div></div>
      <div class="stat-card"><div class="label">Active</div><div class="value green">${active}</div></div>
      <div class="stat-card"><div class="label">Suspended</div><div class="value red">${suspended}</div></div>`;

    if (!users.length) {
      container.innerHTML = '<div class="empty-state"><p>No registered users found.</p></div>';
      return;
    }

    let html = `<table><thead><tr><th>User</th><th>Department</th><th>Date of Signup</th><th>Status</th></tr></thead><tbody>`;
    users.forEach((u, i) => {
      const status = u.suspended ? '<span class="badge badge-suspended">Suspended</span>' : '<span class="badge badge-active">Active</span>';
      const date = u.dateOfSignup ? new Date(u.dateOfSignup).toLocaleDateString('en-GB') : '-';
      html += `<tr class="clickable-row" data-idx="${i}">
        <td><div class="user-cell"><img src="${u.avatar || ''}" alt="" onerror="this.src='${defaultAvatar(u.discordId || '0')}'"/><div><div class="name">${esc(u.name || u.discordName || 'Unknown')}</div><div class="id">${esc(u.discordId || '')}</div></div></div></td>
        <td>${esc(u.department || '-')}</td>
        <td>${date}</td>
        <td>${status}</td>
      </tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;

    // Click handler for rows
    container.querySelectorAll('.clickable-row').forEach(row => {
      row.addEventListener('click', () => openUserPanel(parseInt(row.dataset.idx)));
    });

    // Populate user selects
    populateUserSelects(users);
  } catch (e) {
    container.innerHTML = `<div class="empty-state"><p>Error loading users: ${esc(e.message)}</p></div>`;
  }
}

function populateUserSelects(users) {
  const selects = ['payslipUser', 'reportUser', 'strikeUser'];
  selects.forEach(id => {
    const sel = document.getElementById(id);
    if (!sel) return;
    sel.innerHTML = '<option value="">Select user...</option>';
    users.forEach(u => {
      sel.innerHTML += `<option value="${esc(u.discordId)}">${esc(u.name || u.discordName || u.discordId)}</option>`;
    });
  });
}

/* ================================================================
   LOAD ABSENCES
   ================================================================ */
async function loadAbsences() {
  const container = document.getElementById('absencesTable');
  container.innerHTML = '<div class="loading-inline">Loading absences...</div>';
  try {
    const data = await apiGet('/api/admin/absences');
    const absences = data.absences || [];
    state.absences = absences;

    const pending = absences.filter(a => a.status === 'pending').length;
    const approved = absences.filter(a => a.status === 'approved').length;
    const rejected = absences.filter(a => a.status === 'rejected').length;
    document.getElementById('absencesStats').innerHTML = `
      <div class="stat-card"><div class="label">Total</div><div class="value blue">${absences.length}</div></div>
      <div class="stat-card"><div class="label">Pending</div><div class="value orange">${pending}</div></div>
      <div class="stat-card"><div class="label">Approved</div><div class="value green">${approved}</div></div>
      <div class="stat-card"><div class="label">Rejected</div><div class="value red">${rejected}</div></div>`;

    if (!absences.length) { container.innerHTML = '<div class="empty-state"><p>No absences found.</p></div>'; return; }

    let html = `<table><thead><tr><th>Name</th><th>Start</th><th>End</th><th>Reason</th><th>Days</th><th>Comment</th><th>Status</th><th>Actions</th></tr></thead><tbody>`;
    absences.forEach((a, i) => {
      const badge = a.status === 'approved' ? 'badge-approved' : a.status === 'rejected' ? 'badge-rejected' : 'badge-pending';
      const actions = a.status === 'pending'
        ? `<button class="btn btn-green btn-small" onclick="absenceAction(${i},'Approved')">Approve</button> <button class="btn btn-red btn-small" onclick="absenceAction(${i},'Rejected')">Deny</button>`
        : `<span style="font-size:11px;color:var(--text2)">${a.status}</span>`;
      html += `<tr>
        <td>${esc(a.name)}</td><td>${esc(a.startDate)}</td><td>${esc(a.endDate)}</td>
        <td>${esc(a.reason)}</td><td>${a.totalDays}</td><td>${esc(a.comment)}</td>
        <td><span class="badge ${badge}">${a.status}</span></td><td>${actions}</td>
      </tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (e) {
    container.innerHTML = `<div class="empty-state"><p>Error: ${esc(e.message)}</p></div>`;
  }
}

function absenceAction(idx, status) {
  const a = state.absences[idx];
  if (!a) return;
  state.pendingAction = { type: 'absence', item: a, status };
  document.getElementById('actionModalTitle').textContent = status === 'Approved' ? 'Approve Absence' : 'Deny Absence';
  document.getElementById('actionModalText').textContent = `${status === 'Approved' ? 'Approve' : 'Deny'} absence for ${a.name} (${a.startDate} - ${a.endDate})?`;
  document.getElementById('actionReason').value = '';
  openModal('actionModal');
}

/* ================================================================
   LOAD REQUESTS
   ================================================================ */
async function loadRequests() {
  const container = document.getElementById('requestsTable');
  container.innerHTML = '<div class="loading-inline">Loading requests...</div>';
  try {
    const data = await apiGet('/api/admin/requests');
    const requests = data.requests || [];
    state.requests = requests;

    const pending = requests.filter(r => ['submit','pending'].includes((r.status||'').toLowerCase())).length;
    document.getElementById('requestsStats').innerHTML = `
      <div class="stat-card"><div class="label">Total</div><div class="value blue">${requests.length}</div></div>
      <div class="stat-card"><div class="label">Pending</div><div class="value orange">${pending}</div></div>`;

    if (!requests.length) { container.innerHTML = '<div class="empty-state"><p>No requests found.</p></div>'; return; }

    let html = `<table><thead><tr><th>User</th><th>Type</th><th>Comment</th><th>Date</th><th>Status</th><th>Actions</th></tr></thead><tbody>`;
    requests.forEach((r, i) => {
      const st = (r.status || 'pending').toLowerCase();
      const isPending = ['submit','pending'].includes(st);
      const badge = st.includes('approv') ? 'badge-approved' : st.includes('denied') || st.includes('reject') ? 'badge-rejected' : 'badge-pending';
      const actions = isPending
        ? `<button class="btn btn-green btn-small" onclick="requestAction(${i},true)">Approve</button> <button class="btn btn-red btn-small" onclick="requestAction(${i},false)">Deny</button>`
        : `<span style="font-size:11px;color:var(--text2)">${r.status}</span>`;
      const date = r.timestamp ? new Date(r.timestamp).toLocaleDateString('en-GB') : '-';
      html += `<tr><td>${esc(r.name || r.userId)}</td><td>${esc(r.type || r.request)}</td><td>${esc(r.comment || r.userComment || '')}</td><td>${date}</td><td><span class="badge ${badge}">${esc(r.status || 'Pending')}</span></td><td>${actions}</td></tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (e) {
    container.innerHTML = `<div class="empty-state"><p>Error: ${esc(e.message)}</p></div>`;
  }
}

function requestAction(idx, approved) {
  const r = state.requests[idx];
  if (!r) return;
  state.pendingAction = { type: 'request', item: r, approved };
  document.getElementById('actionModalTitle').textContent = approved ? 'Approve Request' : 'Deny Request';
  document.getElementById('actionModalText').textContent = `${approved ? 'Approve' : 'Deny'} ${r.type || 'request'} from ${r.name || r.userId}?`;
  document.getElementById('actionReason').value = '';
  openModal('actionModal');
}

/* ================================================================
   LOAD PAYSLIPS
   ================================================================ */
async function loadPayslips() {
  const container = document.getElementById('payslipsTable');
  container.innerHTML = '<div class="loading-inline">Loading payslips...</div>';
  try {
    const data = await apiGet('/api/admin/payslips');
    const payslips = data.payslips || [];
    state.payslips = payslips;

    document.getElementById('payslipsStats').innerHTML = `
      <div class="stat-card"><div class="label">Total Payslips</div><div class="value blue">${payslips.length}</div></div>`;

    if (!payslips.length) { container.innerHTML = '<div class="empty-state"><p>No payslips found.</p></div>'; return; }

    let html = `<table><thead><tr><th>User</th><th>Period</th><th>Assigned By</th><th>Date</th><th>Status</th><th>Link</th></tr></thead><tbody>`;
    payslips.forEach(p => {
      const user = state.users.find(u => u.discordId === p.userId);
      const name = user ? user.name : p.userId;
      const date = p.dateAssigned ? new Date(p.dateAssigned).toLocaleDateString('en-GB') : '-';
      html += `<tr><td>${esc(name)}</td><td>${esc(p.period || '-')}</td><td>${esc(p.assignedBy || '-')}</td><td>${date}</td><td><span class="badge badge-issued">${esc(p.status || 'Issued')}</span></td><td>${p.link ? `<a href="${esc(p.link)}" target="_blank" style="color:var(--accent)">View</a>` : '-'}</td></tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (e) {
    container.innerHTML = `<div class="empty-state"><p>Error: ${esc(e.message)}</p></div>`;
  }
}

/* ================================================================
   LOAD REPORTS
   ================================================================ */
async function loadReports() {
  const container = document.getElementById('reportsTable');
  container.innerHTML = '<div class="loading-inline">Loading reports...</div>';
  try {
    const data = await apiGet('/api/admin/reports');
    const reports = data.reports || [];
    state.reports = reports;

    const comm = reports.filter(r => r.type === 'Commendation').length;
    const neg = reports.filter(r => r.type !== 'Commendation' && r.type !== 'Monthly Report').length;
    document.getElementById('reportsStats').innerHTML = `
      <div class="stat-card"><div class="label">Total</div><div class="value blue">${reports.length}</div></div>
      <div class="stat-card"><div class="label">Commendations</div><div class="value green">${comm}</div></div>
      <div class="stat-card"><div class="label">Negative</div><div class="value red">${neg}</div></div>`;

    if (!reports.length) { container.innerHTML = '<div class="empty-state"><p>No reports found.</p></div>'; return; }

    let html = `<table><thead><tr><th>User</th><th>Type</th><th>Description</th><th>Published By</th><th>Date</th><th>Points</th></tr></thead><tbody>`;
    reports.forEach(r => {
      const user = state.users.find(u => u.discordId === r.userId);
      const name = user ? user.name : r.userId;
      const pts = REPORT_POINTS[r.type] || 0;
      const ptsClass = pts > 0 ? 'color:var(--green)' : pts < 0 ? 'color:var(--red)' : 'color:var(--text2)';
      const date = r.timestamp ? new Date(r.timestamp).toLocaleDateString('en-GB') : '-';
      html += `<tr><td>${esc(name)}</td><td>${esc(r.type || '-')}</td><td>${esc(r.comment || '-')}</td><td>${esc(r.publishedBy || '-')}</td><td>${date}</td><td style="${ptsClass};font-weight:600">${pts > 0 ? '+' : ''}${pts}</td></tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (e) {
    container.innerHTML = `<div class="empty-state"><p>Error: ${esc(e.message)}</p></div>`;
  }
}

/* ================================================================
   LOAD STRIKES
   ================================================================ */
async function loadStrikes() {
  const container = document.getElementById('strikesTable');
  container.innerHTML = '<div class="loading-inline">Loading disciplinaries...</div>';
  try {
    const data = await apiGet('/api/admin/strikes');
    const strikes = data.strikes || [];
    state.strikes = strikes;

    document.getElementById('strikesStats').innerHTML = `
      <div class="stat-card"><div class="label">Total</div><div class="value red">${strikes.length}</div></div>`;

    if (!strikes.length) { container.innerHTML = '<div class="empty-state"><p>No disciplinaries found.</p></div>'; return; }

    let html = `<table><thead><tr><th>User</th><th>Type</th><th>Reason</th><th>Assigned By</th><th>Date</th><th>Points</th></tr></thead><tbody>`;
    strikes.forEach(s => {
      const user = state.users.find(u => u.discordId === s.userId);
      const name = user ? user.name : s.userId;
      const pts = STRIKE_POINTS[s.strikeType] || (s.customPoints ? -Math.abs(s.customPoints) : 0);
      const date = s.timestamp ? new Date(s.timestamp).toLocaleDateString('en-GB') : '-';
      html += `<tr><td>${esc(name)}</td><td>${esc(s.strikeType || '-')}</td><td>${esc(s.reason || s.comment || '-')}</td><td>${esc(s.assignedBy || '-')}</td><td>${date}</td><td style="color:var(--red);font-weight:600">${pts}</td></tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (e) {
    container.innerHTML = `<div class="empty-state"><p>Error: ${esc(e.message)}</p></div>`;
  }
}

/* ================================================================
   LOAD CALENDAR EVENTS
   ================================================================ */
async function loadCalendar() {
  const container = document.getElementById('calendarTable');
  container.innerHTML = '<div class="loading-inline">Loading events...</div>';
  try {
    const data = await apiGet('/api/calendar/events');
    const events = data.events || [];
    state.calendarEvents = events;

    const today = new Date();
    const thisMonth = events.filter(e => {
      const d = new Date(e.date);
      return d.getMonth() === today.getMonth() && d.getFullYear() === today.getFullYear();
    });
    const upcoming = events.filter(e => new Date(e.date) >= today);

    document.getElementById('calendarEventsCount').textContent = events.length;
    document.getElementById('calendarThisMonth').textContent = thisMonth.length;
    document.getElementById('calendarUpcoming').textContent = upcoming.length;

    if (!events.length) { container.innerHTML = '<div class="empty-state"><p>No calendar events found.</p></div>'; return; }

    let html = `<table><thead><tr><th>Date</th><th>Title</th><th>Type</th><th>Description</th><th>Created By</th></tr></thead><tbody>`;
    events.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(e => {
      const date = e.date ? new Date(e.date).toLocaleDateString('en-GB') : '-';
      const typeColor = e.type === 'meeting' ? 'var(--accent)' : e.type === 'deadline' ? 'var(--red)' : e.type === 'holiday' ? 'var(--green)' : 'var(--text2)';
      html += `<tr><td>${esc(date)}</td><td style="font-weight:600">${esc(e.title || '-')}</td><td><span style="color:${typeColor};text-transform:capitalize">${esc(e.type || 'event')}</span></td><td style="max-width:300px;overflow:hidden;text-overflow:ellipsis">${esc(e.description || '-')}</td><td>${esc(e.createdBy || '-')}</td></tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (e) {
    container.innerHTML = `<div class="empty-state"><p>Error: ${esc(e.message)}</p></div>`;
  }
}

/* ================================================================
   LOAD ADMIN LOGS
   ================================================================ */
async function loadLogs() {
  const container = document.getElementById('logsTable');
  container.innerHTML = '<div class="loading-inline">Loading logs...</div>';
  try {
    const data = await apiGet('/api/admin/logs');
    const logs = data.logs || [];
    state.logs = logs;

    const today = new Date().toDateString();
    const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
    const logsToday = logs.filter(l => new Date(l.timestamp).toDateString() === today);
    const logsThisWeek = logs.filter(l => new Date(l.timestamp) >= weekAgo);

    document.getElementById('logsCount').textContent = logs.length;
    document.getElementById('logsToday').textContent = logsToday.length;
    document.getElementById('logsThisWeek').textContent = logsThisWeek.length;

    if (!logs.length) { container.innerHTML = '<div class="empty-state"><p>No admin activity logs found.</p></div>'; return; }

    let html = `<table><thead><tr><th>Timestamp</th><th>Admin</th><th>Action</th><th>Details</th></tr></thead><tbody>`;
    logs.slice(0, 100).forEach(l => {
      const time = l.timestamp ? new Date(l.timestamp).toLocaleString('en-GB') : '-';
      const admin = state.users.find(u => u.discordId === l.adminId);
      const adminName = admin ? admin.name : l.adminId || '-';
      const actionColor = l.action?.includes('approv') ? 'var(--green)' : l.action?.includes('deny') || l.action?.includes('reject') ? 'var(--red)' : 'var(--text)';
      html += `<tr><td style="white-space:nowrap">${esc(time)}</td><td>${esc(adminName)}</td><td style="color:${actionColor}">${esc(l.action || '-')}</td><td style="max-width:400px;overflow:hidden;text-overflow:ellipsis">${esc(l.details || '-')}</td></tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (e) {
    container.innerHTML = `<div class="empty-state"><p>Error: ${esc(e.message)}</p></div>`;
  }
}

// Helper function to log admin actions
async function logAdminAction(action, details, targetId = '') {
  try {
    await apiPost('/api/admin/logs', {
      adminId: state.admin?.id,
      action,
      details,
      targetId
    });
  } catch (e) {
    console.error('Failed to log admin action:', e);
  }
}

/* ================================================================
   USER PANEL
   ================================================================ */
async function openUserPanel(idx) {
  const user = state.users[idx];
  if (!user) return;
  state.selectedUser = user;

  const panel = document.getElementById('userPanel');
  const overlay = document.getElementById('panelOverlay');
  const content = document.getElementById('panelContent');

  content.innerHTML = '<div class="loading-inline">Loading profile...</div>';
  panel.classList.add('open');
  overlay.classList.add('active');

  // Fetch full account data
  let account = null;
  try {
    if (user.discordId) {
      const data = await apiGet(`/api/accounts/${user.discordId}`);
      if (data.success) account = data.account;
    }
  } catch (e) {}

  // Calculate points
  let pts = parseInt(user.points) || 0;
  if (account) {
    // Calculate from reports and strikes
    const reportPts = (account.reports || []).reduce((sum, r) => sum + (REPORT_POINTS[r.type] || 0), 0);
    const strikePts = (account.disciplinaries || []).reduce((sum, s) => sum + (STRIKE_POINTS[s.strikeType] || 0), 0);
    pts = reportPts + strikePts;
  }

  const avatarSrc = user.avatar || defaultAvatar(user.discordId || '0');
  const statusBadge = user.suspended ? '<span class="badge badge-suspended">Suspended</span>' : '<span class="badge badge-active">Active</span>';
  const ptsClass = pts >= 0 ? 'positive' : 'negative';

  content.innerHTML = `
    <div class="panel-profile">
      <img src="${avatarSrc}" alt="" onerror="this.src='${defaultAvatar(user.discordId || '0')}'" />
      <h3>${esc(user.name || user.discordName || 'Unknown')}</h3>
      <div class="dept">${esc(user.department || 'No Department')} ${statusBadge}</div>
      <div class="points-display ${ptsClass}"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg> ${pts} points</div>
    </div>

    <div class="panel-section">
      <h4>Personal Information</h4>
      <div class="info-grid">
        <div class="info-item"><div class="label">Name</div><div class="value" id="pi-name">${esc(user.name || '-')}</div></div>
        <div class="info-item"><div class="label">Email</div><div class="value">${esc(user.email || '-')}</div></div>
        <div class="info-item"><div class="label">Department</div><div class="value">${esc(user.department || '-')}</div></div>
        <div class="info-item"><div class="label">Discord ID</div><div class="value">${esc(user.discordId || '-')}</div></div>
        <div class="info-item"><div class="label">Timezone</div><div class="value">${esc(user.timezone || '-')}</div></div>
        <div class="info-item"><div class="label">Country</div><div class="value">${esc(user.country || '-')}</div></div>
        <div class="info-item"><div class="label">Date of Signup</div><div class="value">${user.dateOfSignup ? new Date(user.dateOfSignup).toLocaleDateString('en-GB') : '-'}</div></div>
        <div class="info-item"><div class="label">Base Level</div><div class="value">${esc(user.baseLevel || '-')}</div></div>
      </div>
    </div>

    <div class="panel-section">
      <h4>Edit Profile</h4>
      <div class="info-grid">
        <div class="info-item"><label class="label" for="edit-dept">Department</label><input id="edit-dept" value="${esc(user.department || '')}" /></div>
        <div class="info-item"><label class="label" for="edit-level">Base Level</label>
          <select id="edit-level">
            <option value="" ${!user.baseLevel ? 'selected' : ''}>None</option>
            <option value="Trainee" ${user.baseLevel==='Trainee' ? 'selected' : ''}>Trainee</option>
            <option value="Junior" ${user.baseLevel==='Junior' ? 'selected' : ''}>Junior</option>
            <option value="Member" ${user.baseLevel==='Member' ? 'selected' : ''}>Member</option>
            <option value="Senior" ${user.baseLevel==='Senior' ? 'selected' : ''}>Senior</option>
            <option value="Lead" ${user.baseLevel==='Lead' ? 'selected' : ''}>Lead</option>
            <option value="Manager" ${user.baseLevel==='Manager' ? 'selected' : ''}>Manager</option>
            <option value="Director" ${user.baseLevel==='Director' ? 'selected' : ''}>Director</option>
          </select>
        </div>
      </div>
      <button class="btn btn-primary" style="margin-top:12px;width:100%" onclick="saveUserProfile()">Save Changes</button>
    </div>

    <div class="panel-tabs">
      <button class="panel-tab active" data-ptab="ptab-absences">Absences</button>
      <button class="panel-tab" data-ptab="ptab-payslips">Payslips</button>
      <button class="panel-tab" data-ptab="ptab-reports">Reports</button>
      <button class="panel-tab" data-ptab="ptab-strikes">Strikes</button>
      <button class="panel-tab" data-ptab="ptab-requests">Requests</button>
    </div>

    <div class="panel-tab-content active" id="ptab-absences">
      ${renderPanelList(account?.absences, 'absence')}
    </div>
    <div class="panel-tab-content" id="ptab-payslips">
      ${renderPanelList(account?.payslips, 'payslip')}
    </div>
    <div class="panel-tab-content" id="ptab-reports">
      ${renderPanelList(account?.reports, 'report')}
    </div>
    <div class="panel-tab-content" id="ptab-strikes">
      ${renderPanelList(account?.disciplinaries, 'strike')}
    </div>
    <div class="panel-tab-content" id="ptab-requests">
      ${renderPanelList(account?.requests, 'request')}
    </div>

    <div class="panel-actions">
      ${user.suspended
        ? `<button class="btn btn-green" onclick="toggleSuspend(false)">Unsuspend User</button>`
        : `<button class="btn btn-red" onclick="toggleSuspend(true)">Suspend User</button>`
      }
      <button class="btn" style="background:var(--red);color:#fff;opacity:.8" onclick="removeAccount()">Remove Account</button>
    </div>`;

  // Panel tab switching
  content.querySelectorAll('.panel-tab').forEach(tab => {
    tab.addEventListener('click', () => {
      content.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
      content.querySelectorAll('.panel-tab-content').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      const target = document.getElementById(tab.dataset.ptab);
      if (target) target.classList.add('active');
    });
  });
}

function renderPanelList(items, type) {
  if (!items || !items.length) return '<div style="padding:16px;color:var(--text2);font-size:13px;text-align:center">No records found.</div>';
  return items.map(item => {
    switch(type) {
      case 'absence': return `<div class="panel-list-item"><div class="row"><span>${esc(item.reason || item.type || '-')}</span><span class="badge ${item.status === 'approved' ? 'badge-approved' : item.status === 'rejected' ? 'badge-rejected' : 'badge-pending'}">${item.status || 'pending'}</span></div><div class="row" style="color:var(--text2);font-size:12px"><span>${esc(item.startDate || '')}  ${esc(item.endDate || '')}</span><span>${item.totalDays || '-'} days</span></div></div>`;
      case 'payslip': return `<div class="panel-list-item"><div class="row"><span>${esc(item.period || item.payPeriod || '-')}</span><span style="font-size:12px;color:var(--text2)">${item.dateAssigned || item.timestamp || ''}</span></div>${item.link ? `<div class="row"><a href="${esc(item.link)}" target="_blank" style="color:var(--accent);font-size:12px">View Payslip</a></div>` : ''}</div>`;
      case 'report': return `<div class="panel-list-item"><div class="row"><span>${esc(item.type || '-')}</span><span style="font-weight:600;${(REPORT_POINTS[item.type]||0)>0?'color:var(--green)':'color:var(--red)'}">${(REPORT_POINTS[item.type]||0) > 0 ? '+' : ''}${REPORT_POINTS[item.type]||0}pts</span></div><div style="font-size:12px;color:var(--text2);margin-top:4px">${esc(item.comment || '-')}</div></div>`;
      case 'strike': return `<div class="panel-list-item"><div class="row"><span>${esc(item.strikeType || item.type || '-')}</span><span style="font-weight:600;color:var(--red)">${STRIKE_POINTS[item.strikeType || item.type] || 0}pts</span></div><div style="font-size:12px;color:var(--text2);margin-top:4px">${esc(item.reason || item.comment || item.description || '-')}</div></div>`;
      case 'request': return `<div class="panel-list-item"><div class="row"><span>${esc(item.type || '-')}</span><span class="badge ${(item.status||'').toLowerCase().includes('approv') ? 'badge-approved' : (item.status||'').toLowerCase().includes('den') || (item.status||'').toLowerCase().includes('reject') ? 'badge-rejected' : 'badge-pending'}">${item.status || 'Pending'}</span></div><div style="font-size:12px;color:var(--text2);margin-top:4px">${esc(item.comment || '-')}</div></div>`;
      default: return '';
    }
  }).join('');
}

function closeUserPanel() {
  document.getElementById('userPanel').classList.remove('open');
  document.getElementById('panelOverlay').classList.remove('active');
  state.selectedUser = null;
}
document.getElementById('closePanelBtn').addEventListener('click', closeUserPanel);
document.getElementById('panelOverlay').addEventListener('click', closeUserPanel);

/* ================================================================
   USER ACTIONS
   ================================================================ */
async function saveUserProfile() {
  const user = state.selectedUser;
  if (!user) return;
  const dept = document.getElementById('edit-dept')?.value || '';
  const level = document.getElementById('edit-level')?.value || '';
  try {
    await apiPost('/api/admin/user/update', { discordId: user.discordId, department: dept, baseLevel: level });
    toast('Profile updated successfully', 'success');
    user.department = dept;
    user.baseLevel = level;
    await loadUsers();
  } catch (e) {
    toast('Failed to update profile', 'error');
  }
}

async function toggleSuspend(suspend) {
  const user = state.selectedUser;
  if (!user || !confirm(`${suspend ? 'Suspend' : 'Unsuspend'} ${user.name || user.discordId}?`)) return;
  try {
    await apiPost('/api/admin/user/update', { discordId: user.discordId, utilisation: suspend ? 'Suspended' : '' });
    toast(suspend ? 'User suspended' : 'User unsuspended', 'success');
    closeUserPanel();
    await loadUsers();
  } catch (e) {
    toast('Failed to update user', 'error');
  }
}

async function removeAccount() {
  const user = state.selectedUser;
  if (!user) return;
  if (!confirm(`PERMANENTLY remove ${user.name || user.discordId}? This cannot be undone.`)) return;
  if (!confirm('Are you absolutely sure? All data will be deleted.')) return;
  try {
    await apiPost('/api/users/workflow/reset', { userId: user.discordId, rowIndex: user.rowIndex || 3 });
    toast('Account removed', 'success');
    closeUserPanel();
    await loadUsers();
  } catch (e) {
    toast('Failed to remove account', 'error');
  }
}

/* ================================================================
   ACTION MODAL (APPROVE/DENY WITH REASON)
   ================================================================ */
document.getElementById('actionConfirmBtn').addEventListener('click', async () => {
  const action = state.pendingAction;
  if (!action) return;
  const reason = document.getElementById('actionReason').value.trim();

  try {
    if (action.type === 'absence') {
      await apiPost('/api/admin/absence/update-status', {
        rowIndex: action.item.rowIndex,
        status: action.status,
        reason: reason,
        approver: state.admin.name
      });
      // Log admin action
      await logAdminAction(
        action.status === 'Approved' ? 'absence_approved' : 'absence_denied',
        `${state.admin.name} ${action.status.toLowerCase()} ${action.item.name}'s absence request${reason ? ': ' + reason : ''}`,
        action.item.userId || action.item.discordId
      );
      toast(`Absence ${action.status.toLowerCase()} for ${action.item.name}${reason ? '  Reason: ' + reason : ''}`, action.status === 'Approved' ? 'success' : 'info');
      await loadAbsences();
    } else if (action.type === 'request') {
      await apiPost('/api/admin/requests/update-status', {
        rowIndex: action.item.rowIndex,
        approved: action.approved,
        reason: reason,
        approver: state.admin.name
      });
      // Log admin action
      await logAdminAction(
        action.approved ? 'request_approved' : 'request_denied',
        `${state.admin.name} ${action.approved ? 'approved' : 'denied'} ${action.item.name || action.item.userId}'s ${action.item.type || 'request'}${reason ? ': ' + reason : ''}`,
        action.item.userId || action.item.discordId
      );
      toast(`Request ${action.approved ? 'approved' : 'denied'} for ${action.item.name || action.item.userId}${reason ? '  Reason: ' + reason : ''}`, action.approved ? 'success' : 'info');
      await loadRequests();
    }
  } catch (e) {
    toast('Action failed: ' + e.message, 'error');
  }
  closeModal('actionModal');
  state.pendingAction = null;
});

/* ================================================================
   SEND PAYSLIP
   ================================================================ */
document.getElementById('sendPayslipBtn').addEventListener('click', async () => {
  const userId = document.getElementById('payslipUser').value;
  const period = document.getElementById('payslipPeriod').value.trim();
  const link = document.getElementById('payslipLink').value.trim();
  const comment = document.getElementById('payslipComment').value.trim();

  if (!userId) { toast('Select a user', 'error'); return; }
  if (!link) { toast('Enter a payslip link', 'error'); return; }

  const user = state.users.find(u => u.discordId === userId);
  const userName = user ? user.name : userId;

  try {
    await apiPost('/api/admin/payslips/create', {
      userId, period, link, comment, assignedBy: state.admin.name
    });
    // Log admin action
    await logAdminAction('payslip_sent', `${state.admin.name} sent payslip for ${period || 'N/A'} to ${userName}`, userId);
    toast('Payslip sent successfully', 'success');
    closeModal('payslipModal');
    document.getElementById('payslipPeriod').value = '';
    document.getElementById('payslipLink').value = '';
    document.getElementById('payslipComment').value = '';
    await loadPayslips();
  } catch (e) {
    toast('Failed to send payslip', 'error');
  }
});

/* ================================================================
   ISSUE REPORT
   ================================================================ */
document.getElementById('sendReportBtn').addEventListener('click', async () => {
  const userId = document.getElementById('reportUser').value;
  const type = document.getElementById('reportType').value;
  const desc = document.getElementById('reportDesc').value.trim();

  if (!userId || !type) { toast('Select user and report type', 'error'); return; }
  if (!desc) { toast('Enter a description', 'error'); return; }

  const user = state.users.find(u => u.discordId === userId);
  const userName = user ? user.name : userId;

  try {
    await apiPost('/api/reports/create', {
      userId, type, comment: desc, publishedBy: state.admin.name, scale: type
    });
    // Trigger DM notification
    const pts = REPORT_POINTS[type] || 0;
    await apiPost('/api/send-dm', {
      userId,
      embed: {
        title: type === 'Commendation' ? ' New Commendation!' : ' New Report',
        description: `You have received a new report: **${type}**\n\n${desc}\n\n**Points:** ${pts > 0 ? '+' : ''}${pts}\n\nIssued by: ${state.admin.name}`,
        color: pts > 0 ? 0x22c55e : pts < 0 ? 0xef4444 : 0x3b82f6
      }
    });
    // Log admin action
    await logAdminAction('report_issued', `${state.admin.name} issued ${type} to ${userName}: ${desc}`, userId);
    toast('Report issued successfully', 'success');
    closeModal('reportModal');
    document.getElementById('reportDesc').value = '';
    document.getElementById('reportType').value = '';
    await loadReports();
  } catch (e) {
    toast('Failed to issue report', 'error');
  }
});

/* ================================================================
   ISSUE DISCIPLINARY
   ================================================================ */
function toggleStrikePoints() {
  const v = document.getElementById('strikeType').value;
  document.getElementById('customPointsField').style.display = v === 'Other' ? 'block' : 'none';
}

document.getElementById('sendStrikeBtn').addEventListener('click', async () => {
  const userId = document.getElementById('strikeUser').value;
  const type = document.getElementById('strikeType').value;
  const desc = document.getElementById('strikeDesc').value.trim();
  const customPts = parseInt(document.getElementById('strikeCustomPoints').value) || 0;

  if (!userId || !type) { toast('Select user and strike type', 'error'); return; }
  if (!desc) { toast('Enter a description', 'error'); return; }

  const pts = type === 'Other' ? -Math.abs(customPts) : (STRIKE_POINTS[type] || 0);
  const user = state.users.find(u => u.discordId === userId);
  const userName = user ? user.name : userId;

  try {
    await apiPost('/api/disciplinaries/create', {
      userId, strikeType: type, reason: desc, employer: state.admin.name, customPoints: pts
    });
    // Send DM
    await apiPost('/api/send-dm', {
      userId,
      embed: {
        title: ' Disciplinary Notice',
        description: `You have received a disciplinary: **${type}**\n\n${desc}\n\n**Points:** ${pts}\n\nIssued by: ${state.admin.name}`,
        color: 0xef4444
      }
    });
    // Log admin action
    await logAdminAction('disciplinary_issued', `${state.admin.name} issued ${type} to ${userName}: ${desc}`, userId);
    toast('Disciplinary issued', 'success');
    closeModal('strikeModal');
    document.getElementById('strikeDesc').value = '';
    document.getElementById('strikeType').value = '';
    document.getElementById('strikeCustomPoints').value = '';
    toggleStrikePoints();
    await loadStrikes();
  } catch (e) {
    toast('Failed to issue disciplinary', 'error');
  }
});

/* ================================================================
   ADD CALENDAR EVENT
   ================================================================ */
document.getElementById('addCalendarEventBtn').addEventListener('click', async () => {
  const date = document.getElementById('eventDate').value;
  const title = document.getElementById('eventTitle').value.trim();
  const type = document.getElementById('eventType').value;
  const description = document.getElementById('eventDescription').value.trim();

  if (!date || !title) { toast('Enter date and title', 'error'); return; }

  try {
    await apiPost('/api/calendar/events', {
      date, title, type, description, createdBy: state.admin.name
    });
    // Log admin action
    await logAdminAction('calendar_event_added', `${state.admin.name} added event "${title}" on ${date}`, title);
    toast('Event added successfully', 'success');
    closeModal('calendarEventModal');
    document.getElementById('eventDate').value = '';
    document.getElementById('eventTitle').value = '';
    document.getElementById('eventDescription').value = '';
    document.getElementById('eventType').value = 'event';
    await loadCalendar();
  } catch (e) {
    toast('Failed to add event', 'error');
  }
});

/* ================================================================
   MODAL & TOAST HELPERS
   ================================================================ */
function openModal(id) { document.getElementById(id).classList.add('active'); }
function closeModal(id) { document.getElementById(id).classList.remove('active'); }
function toast(msg, type = 'info') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast ' + type + ' show';
  setTimeout(() => t.classList.remove('show'), 4000);
}
function esc(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = String(s); return d.innerHTML; }

/* ================================================================
   LOGOUT
   ================================================================ */
document.getElementById('logoutBtn').addEventListener('click', () => {
  if (confirm('Log out?')) {
    state = { admin: null, users: [], discordMembers: [], absences: [], requests: [], payslips: [], reports: [], strikes: [], activeTab: 'users', selectedUser: null, pendingAction: null };
    showScreen('loginScreen');
    document.getElementById('discordIdInput').value = '';
    document.getElementById('pinInput').value = '';
    document.getElementById('loginBtn').disabled = false;
  }
});

/* ================================================================
   AUTO REFRESH (every 60s)
   ================================================================ */
setInterval(() => {
  if (state.admin && document.getElementById('dashboard').classList.contains('active')) {
    loadTab(state.activeTab);
  }
}, 60000);

/* ================================================================
   INIT
   ================================================================ */
generateStars();
</script>
</body>
</html>
